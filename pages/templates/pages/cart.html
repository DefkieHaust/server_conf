{% extends "pages/base.html" %}

{% load static %}

{% load mathfilters %}

{% block title %}
The Milky Way | Orders
{% endblock title %}

{% block desc %}
Orders page
{% endblock desc %}

{% block head-extra %}
<style>
  .btn-primary {
    color: #fff;
    background-color: #0d6efd;
  }
  .hr-1 {
    background-color: #fff;
    height: 2px;
    width: %100;
  }
  .acc-1 {
    background-color: #444;
    color: #fff;
  }
  .acc-2 {
    background-color: #333;
    color: #fff;
  }
  .accb-1 {
    background-color: #222;
    color: #fff;
  }
</style>
{% endblock head-extra %}

{% block main %}

<main>
    <div class="container">
      <div class="row d-flex justify-content-center py-vh-3 pb-0">

        <div class="col-12">

          <form method="POST" id="cart-form" action="#">
            {% csrf_token %}

            <h1>Cart</h1>
            <hr>
            <div class="table-responsive">
              <table class="table table-dark table-striped table-hover">
                <thead>
                  <tr>
                    <th scope="col">
                      <input class="form-check-input" type="checkbox" value="" id="selectall">
                    </th>
                    <th scope="col">#</th>
                    <th scope="col">Product</th>
                    <th scope="col">Amount</th>
                    <th scope="col">Total</th>
                  </tr>
                </thead>
                <tbody class="table-group-divider">
                  {% for item in cartitems  %}
                    <tr>
                      <th>
                        <input class="form-check-input" type="checkbox" name="{{ item.pk }}" value="{{ item.pk }}" id="select1">
                      </th>
                      <th scope="row">
                        {{ forloop.counter }}
                      </th>
                      <td class="nowrap">
                        <a href="/market/{{ item.item.product.pk }}" class="link-light link-underline-opacity-0 link-underline-opacity-100-hover">
                          {{ item.item }}
                        </a>
                      </td>
                      <td class="nowrap">
                        {{ item.amount }}
                      </td>
                      <td class="nowrap">
                        ${{ item.item.product.price | mul:item.amount | floatformat }}
                      </td>
                    </tr>
                  {% endfor %}
                  <tr class="table-group-divider">
                    <th colspan="3"></th>
                    <th>Total</th>
                    <th class="nowrap">
                      ${{ total }}
                    </th>
                  </tr>
                </tbody>
              </table>
            </div>

            <button type="submit" class="btn btn-danger mt-2" name="rm_s" value="rm-s" {% if not cartitems %}disabled{% endif %}>Remove Selected</button>
            <hr>
          </form>

            <div class="accordion" id="accordionFlush">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed acc-1" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                    Click to select payment method and provide your shipping address.
                  </button>
                </h2>
                <div id="flush-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionFlush">
                  <div class="accordion-body accb-1">

                    <form method="POST" action="#">
                      {% csrf_token %}

                      <label for="paymemt" class="form-label"><span class="text-light h6">Payment Method:</span></label>
                      <select class="form-control form-control-lg border-dark form-select" id="payment" name="payment_method" required>
                        <option selected disabled value="">Choose...</option>
                        
                        {% for pay_m in pay_ms %}
                        <option>{{ pay_m.name }}</option>
                        {% endfor %}

                      </select>

                    {% if user.allow_bank %}
                    <div id="bank_detail" style="display: none;">
                  <label for="detail" class="form-label mt-2"><span class="text-light h6">Bank Details: (Optional)</span></label>
                  <input type="text" class="form-control form-control-lg border-dark" id="detail" name="detail">
                  <small class="text-secondary">Note: Please provide the name attached to the bank account you are sending from to make it quicker for us to process your payment manually. (This will get your order shipped quicker)</small><br>
                    </div>
                    {% endif %}


                      <label for="shipment" class="form-label mt-2"><span class="text-light h6">Shipment:</span></label>
                      <select class="form-control form-control-lg border-dark form-select" id="shipment" name="shipment_method" required>
                        <option selected disabled value="">Choose...</option>
                        
                        {% for ship_m in ship_ms %}
                        <option value="{{ ship_m.name }}">{{ ship_m.name }} (${{ ship_m.fee }})</option>
                        {% endfor %}

                      </select>

                      <label for="address" class="form-label mt-2"><span class="text-light h6">Address:</span></label>
                      <select class="form-control form-control-lg border-dark form-select" id="address" name="address" required>
                        <option selected disabled value="">Choose...</option>
                        
                        {% for address in addresses %}
                        <option value="{{ address.pk }}">{{ address.name }}</option>
                        {% endfor %}

                      </select>
                      <p class="small text-secondary">
                        Don't have an address set? <a href="/address/" class="nowrap link-info link-underline-opacity-0 link-underline-opacity-100-hover">Create an address.</a>
                      </p>

                      <h3 class="mt-3">
                        Total: ${{ total }}
                      </h3>
                        <!-- Button trigger modal -->
                      <button {% if total < 1 or not_received %}disabled{% endif %} type="button" class="btn btn-light mt-3" data-bs-toggle="modal" data-bs-target="#cartModal">Place Order</button><br>
                      <small class="text-secondary">Note: You can't order again until you clear the previous order's payment.</small>


                        <!-- Modal -->
                        <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title text-dark" id="exampleModalLabel">Payment Warning!</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <p class="text-dark">Once you confirm your order you are confirming that you have sent the payment. If you don't send the payment before clicking confirm you will be removed from our instagram and website permanently.
                                <br>Note: To avoid potentially losing access simply only place an order when you are ready to pay for it.</p>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary" name="placeorder" value="placeorder">Order</button>
                              </div>
                            </div>
                          </div>
                        </div>





                    </form>
                  </div>

                </div>
              </div>
            </div>


            <div class="hr-1 my-4"></div>

            <a href="/" class="nowrap link-info link-underline-opacity-0 link-underline-opacity-100-hover">> View your orders.</a>

        </div>
      </div>
    </div>
</main>

<script>
let superCheck = document.querySelector('#selectall');
let checkBoxes = document.querySelectorAll('#cart-form input[type="checkbox"]');

superCheck.addEventListener('change', function() {
  if (superCheck.checked) {
    checkBoxes.forEach(function(checkbox) {
      checkbox.checked = true;
    });
  } else {
    checkBoxes.forEach(function(checkbox) {
      checkbox.checked = false;
    });
  }
});
{% if user.allow_bank %}
// Define array of options that should make the bank_detail div visible
const visibleOptions = [
  {% for option in banks %}
  "{{ option.name }}",
  {% endfor %}
];

// Get the select input element and bank_detail div element
const paymentSelect = document.getElementById('payment');
const bankDetailDiv = document.getElementById('bank_detail');

// Add event listener to select input to detect changes in selection
paymentSelect.addEventListener('change', () => {
  const selectedOptionText = paymentSelect.options[paymentSelect.selectedIndex].text;
  if (visibleOptions.includes(selectedOptionText)) {
    // If the selected option text is in the visibleOptions array, make the bank_detail div visible
    bankDetailDiv.style.display = 'block';
  } else {
    // If the selected option text is not in the visibleOptions array, hide the bank_detail div
    bankDetailDiv.style.display = 'none';
  }
});
{% endif %}
</script>

{% endblock main %}
