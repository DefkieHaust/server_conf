{% extends "pages/base.html" %}

{% load static %}

{% load mathfilters %}

{% block title %}
The Milky Way | Orders
{% endblock title %}

{% block desc %}
Orders page
{% endblock desc %}

{% block main %}

{% block head-extra %}
<style>
  .btn-danger {
    color: #fff;
    background-color: #ba110c;
  }
  .hr-1 {
    background-color: #fff;
    height: 2px;
    width: %100;
  }
  .acc-1 {
    background-color: #444;
    color: #fff;
  }
  .acc-2 {
    background-color: #333;
    color: #fff;
  }
  .accb-1 {
    background-color: #222;
    color: #fff;
  }
</style>
{% endblock head-extra %}

<main>
    <div class="container">
      <div class="row d-flex justify-content-center py-vh-3 pb-0">

        <div class="col-12">

          <form method="POST" id="cart-form" action="#">
            {% csrf_token %}

            <h1>Cart</h1>
            <hr>
            <div class="table-responsive">
              <table class="table table-dark table-striped table-hover">
                <thead>
                  <tr>
                    <th scope="col">
                      <input class="form-check-input" type="checkbox" value="" id="selectall">
                    </th>
                    <th scope="col">#</th>
                    <th scope="col">Product</th>
                    <th scope="col">Amount</th>
                    <th scope="col">Total</th>
                  </tr>
                </thead>
                <tbody class="table-group-divider">
                  {% for item in cartitems  %}
                    <tr>
                      <th>
                        <input class="form-check-input" type="checkbox" name="{{ item.pk }}" value="{{ item.pk }}" id="select1">
                      </th>
                      <th scope="row">
                        {{ forloop.counter }}
                      </th>
                      <td class="nowrap">
                        <a href="/market/{{ item.item.product.pk }}" class="link-light link-underline-opacity-0 link-underline-opacity-100-hover">
                          {{ item.item }}
                        </a>
                      </td>
                      <td class="nowrap">
                        {{ item.amount }}
                      </td>
                      <td class="nowrap">
                        ${{ item.item.product.price | mul:item.amount | floatformat }}
                      </td>
                    </tr>
                  {% endfor %}
                  <tr class="table-group-divider">
                    <th colspan="3"></th>
                    <th>Total</th>
                    <th class="nowrap">
                      ${{ total }}
                    </th>
                  </tr>
                </tbody>
              </table>
            </div>

            <button type="submit" class="btn btn-danger mt-2" name="rm_s" value="rm-s" {% if not cartitems %}disabled{% endif %}>Remove Selected</button>
            <hr>
          </form>

            <div class="accordion accordion-flush" id="accordionFlush">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed acc-1" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                    Click to select payment method and provide your shipping address.
                  </button>
                </h2>
                <div id="flush-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionFlush">
                  <div class="accordion-body accb-1">

                    <form method="POST" action="#">
                      {% csrf_token %}

                      <label for="paymemt" class="form-label"><span class="text-light h6">Payment Method:</span></label>
                      <select class="form-control form-control-lg border-dark form-select" id="payment" name="payment_method" required>
                        <option selected disabled value="">Choose...</option>
                        
                        {% for pay_m in pay_ms %}
                        <option>{{ pay_m.name }}</option>
                        {% endfor %}

                      </select>

                      <label for="shipment" class="form-label"><span class="text-light h6">Shipment:</span></label>
                      <select class="form-control form-control-lg border-dark form-select" id="shipment" name="shipment_method" required>
                        <option selected disabled value="">Choose...</option>
                        
                        {% for ship_m in ship_ms %}
                        <option value="{{ ship_m.name }}">{{ ship_m.name }} (${{ ship_m.fee }})</option>
                        {% endfor %}

                      </select>

                      <label for="address" class="form-label"><span class="text-light h6">Address:</span></label>
                      <select class="form-control form-control-lg border-dark form-select" id="address" name="address" required>
                        <option selected disabled value="">Choose...</option>
                        
                        {% for address in addresses %}
                        <option value="{{ address.pk }}">{{ address.name }}</option>
                        {% endfor %}

                      </select>
                      <p class="small text-secondary">
                        Don't have an address set? <a href="/address/" class="nowrap link-info link-underline-opacity-0 link-underline-opacity-100-hover">Create an address.</a>
                      </p>

                      <h3 class="mt-3">
                        Total: ${{ total }}
                      </h3>
                      <button {% if total < 1 %}disabled{% endif %} type="submit" class="btn btn-light mt-3" name="placeorder" value="placeorder">Place Order</button>

                    </form>


                </div>
              </div>
            </div>


            <div class="hr-1 mt-4"></div>

            <h1 class="mt-3">Orders</h1>
            <hr>

            <div class="accordion" id="accordion-round">

              {% if orders %}

                {% for order in orders %}
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button acc-2 collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
                        Click here to pay (Once payment is confirmed, We will ship the order)
                      </button>
                    </h2>
                    <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordion-round">
                      <div class="accordion-body accb-1">
                        <strong>Order Id:</strong><br>
                        {{ order.order_id }}
                        <hr>                      <strong>Order Status:</strong><br>
                        {% if order.payment_received %}
                          {% if order.shipped %}
                            Shipped
                          {% else %}
                            Payment confirmed<br>
                            <p class="text-secondary">Note: we ship orders on Tuesday, Wednesday, Thursday.<br>
                            Tracking number will appear in your email once shipped.</p>
                          {% endif %}
                        {% else %}
                          Waiting for payment
                        {% endif %}
                        <hr>
                        {% if order.shipping_date %}
                          <strong>Shipping Date:</strong><br>
                          {{ order.shipping_date }} (UTC)
                          <hr>
                        {% endif %}
                        <strong>Payment Method:</strong><br>
                        {{ order.payment_method }}
                        <hr>
                        <strong>Pay Amount:</strong><br>
                        ${{ order.pay_amount }}
                        <hr>
                        <strong>Shipment Method:</strong><br>
                        {{ order.shipment_method }} (${{ order.shipment_method.fee }})
                        <hr>
                        <strong>Address:</strong><br>
                        Name: {{ order.address.name}}<br>
                        Street: {{ order.address.street }}<br>
                        City: {{ order.address.city }}<br>
                        Postcode: {{ order.address.postcode }}
                        <hr>
                        <strong>Order Date:</strong><br>
                        {{ order.order_date }} (UTC)
                        <hr>
                        <strong>Ordered Items:</strong><br>

                        <div class="table-responsive">
                          <table class="table table-dark table-striped table-hover">
                            <thead>
                              <tr>
                                <th scope="col">#</th>
                                <th scope="col">Product</th>
                                <th scope="col">Amount</th>
                                <th scope="col">Total</th>
                              </tr>
                            </thead>
                            <tbody class="table-group-divider">

                              {% for item in order.items.all %}
                                <tr>
                                  <th scope="row">
                                    {{ forloop.counter }}
                                  </th>
                                  <td class="nowrap">
                                    {{ item.item }}
                                  </td>
                                  <td class="nowrap">
                                    {{ item.amount }}
                                  </td>
                                  <td class="nowrap">
                                    ${{ item.item.product.price | mul:item.amount }}
                                  </td>
                                </tr>
                              {% endfor %}

                            </tbody>
                          </table>
                        </div>

                      </div>
                    </div>
                  </div>
                {% endfor %}

              {% else %}
                <span class="h5 my-2 ms-3">No orders!</span>
              {% endif %}

            </div>

            <div class="hr-1 mt-4"></div>

            <h1 class="mt-3">User</h1>
            <hr>

            <a href="/logout">
              <button class="btn btn-danger my-2">Logout</button>
            </a>



        </div>
      </div>
    </div>
</main>

<script>
let superCheck = document.querySelector('#selectall');
let checkBoxes = document.querySelectorAll('#cart-form input[type="checkbox"]');

superCheck.addEventListener('change', function() {
  if (superCheck.checked) {
    checkBoxes.forEach(function(checkbox) {
      checkbox.checked = true;
    });
  } else {
    checkBoxes.forEach(function(checkbox) {
      checkbox.checked = false;
    });
  }
});
</script>

{% endblock main %}
